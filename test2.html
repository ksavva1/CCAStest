<!DOCTYPE html>
<html>
	<head>
		<title>test2.html</title>
		<link rel = "stylesheet" type = "text/css" href = "style.css" />
	</head>

	<body>
		<h1>Speech to text V.3</h1>

		<!-- Gain access to the microphone -->
		<audio id="player" controls></audio>
		<script>
		/*Query if microphone has been given access
			navigator.permissions.query({name:'microphone'}).then(function(result) {
				if (result.state == 'granted') {

				} else if (result.state == 'prompt') {

				} else if (result.state == 'denied') {

				}
				result.onchange = function() {

				};
			}); */
			//gain access
			const player = document.getElementById('player');

			const handleSuccess = function(stream) {
			if (window.URL) {
				player.srcObject = stream;
			} else {
				player.src = stream;
			}
			};

			navigator.mediaDevices.getUserMedia({ audio: true, video: false })
				.then(handleSuccess);
		</script>

		<!-- Access raw data from microphone -->
		<script>
		  const handleSuccess = function(stream) {
		    const context = new AudioContext();
		    const source = context.createMediaStreamSource(stream);
		    const processor = context.createScriptProcessor(1024, 1, 1);

		    source.connect(processor);
		    processor.connect(context.destination);

		    processor.onaudioprocess = function(e) {
		      // Do something with the data, e.g. convert it to WAV
		      console.log(e.inputBuffer);
		    };
		  };

		  navigator.mediaDevices.getUserMedia({ audio: true, video: false })
		      .then(handleSuccess);
		</script>

		<!-- Save data from get UserMedia stream progressively to an array. Later will be turned into a blob -->
		<a id="download">Download</a>
		<button id="stop">Stop</button>
		<script>
		  let shouldStop = false;
		  let stopped = false;
		  const downloadLink = document.getElementById('download');
		  const stopButton = document.getElementById('stop');

		  stopButton.addEventListener('click', function() {
		    shouldStop = true;
		  });

		  const handleSuccess = function(stream) {
		    const options = {mimeType: 'audio/webm'};
				//array to hold recorded data
		    const recordedChunks = [];
		    const mediaRecorder = new MediaRecorder(stream, options);

		    mediaRecorder.addEventListener('dataavailable', function(e) {
		      if (e.data.size > 0) {
		        recordedChunks.push(e.data);
		      }

		      if(shouldStop === true && stopped === false) {
		        mediaRecorder.stop();
		        stopped = true;
		      }
		    });

		    mediaRecorder.addEventListener('stop', function() {
		      downloadLink.href = URL.createObjectURL(new Blob(recordedChunks));
		      downloadLink.download = 'acetest.wav';
		    });

		    mediaRecorder.start();
		  };

		  navigator.mediaDevices.getUserMedia({ audio: true, video: false })
		      .then(handleSuccess);

		</script>



  </body>
</html>
